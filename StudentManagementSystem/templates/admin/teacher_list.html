<h3>Teacher List</h3>
<table>
    <thead>
    <tr>
        <th>Teacher ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for teacher in teachers %}
        <tr>
            <td>{{ teacher.teacher_id }}</td>
            <td>{{ teacher.first_name }}</td>
            <td>{{ teacher.last_name }}</td>
            <td>
                <!-- Edit Button for Modal -->
                <button onclick="openEditModal({{ teacher.id }})">Edit</button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Simple Modal for Editing Teacher -->
<div id="editModal"
     style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
    <h4>Edit Teacher</h4>
    <form id="editTeacherForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="teacher_id_edit_modal" id="teacher_id_edit_modal">

        <label for="first_name_modal">First Name:</label><br>
        <input type="text" id="first_name_modal" name="first_name_modal" required><br><br>

        <label for="last_name_modal">Last Name:</label><br>
        <input type="text" id="last_name_modal" name="last_name_modal" required><br><br>

        <label for="password_modal">Password (Optional):</label><br>
        <input type="password" id="password_modal" name="password_modal"><br><br>

        <h5>Handled Sections</h5>
        <table id="sections-table">
            <thead>
            <tr>
                <th>Department</th>
                <th>Year Level</th>
                <th>Section Letter</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Existing sections will be added here -->
            </tbody>
        </table>

        <h5>Add New Section</h5>
        <div id="section-group-container_modal">
            <div class="section-group_modal">
                <label>Department:</label>
                <select name="departments[]" class="dept-select">
                    <option value="">-- Select Department --</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>

                <label>Section Letter:</label>
                <select name="letters[]" class="section-select">
                    <option value="">-- Select Section Letter --</option>
                    {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                        <option value="{{ letter }}">{{ letter }}</option>
                    {% endfor %}
                </select>

                <button type="button" onclick="removeSectionGroup(this)">Remove</button>
            </div>
        </div>

        <button type="button" onclick="addSectionGroupModal()">âž• Add More Sections</button>
        <br><br>
        <button type="submit">Save Changes</button>
    </form>
    <button onclick="closeEditModal()">Close</button>
</div>

<!-- Background overlay to dim the rest of the screen when modal is open -->
<div id="modalOverlay"
     style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

<script>
    // Open the modal and pre-fill the form with teacher data
    function openEditModal(teacherId) {
        fetch(`/admin_teacher/${teacherId}/get_details/`)  // Fetch teacher data
            .then(response => response.json())
            .then(data => {
                document.getElementById('teacher_id_edit_modal').value = data.teacher_id;
                document.getElementById('first_name_modal').value = data.first_name;
                document.getElementById('last_name_modal').value = data.last_name;
                document.getElementById('password_modal').value = '';  // Optional: clear previous password field
                document.getElementById('editModal').style.display = 'block';  // Show modal
                document.getElementById('modalOverlay').style.display = 'block'; // Show background overlay

                // Display existing handled sections in the table
                const sectionTableBody = document.querySelector('#sections-table tbody');
                sectionTableBody.innerHTML = ''; // Clear existing rows
                data.handled_sections.forEach((section) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${section.department}</td>
                        <td>${section.year_level}</td>
                        <td>${section.letter}</td>
                        <td><button type="button" onclick="removeSectionRow(this)">Remove</button></td>
                    `;
                    sectionTableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching teacher data:', error));
    }

    // Close the modal
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';  // Hide modal
        document.getElementById('modalOverlay').style.display = 'none';  // Hide background overlay
    }

    // Add new section group (dropdowns for department and section)
    function addSectionGroupModal() {
        const container = document.getElementById('section-group-container_modal');
        const firstGroup = container.querySelector('.section-group_modal');
        const newGroup = firstGroup.cloneNode(true);

        // Clear values of cloned selects
        const deptSelect = newGroup.querySelector('.dept-select');
        const sectionSelect = newGroup.querySelector('.section-select');

        deptSelect.selectedIndex = 0;
        sectionSelect.selectedIndex = 0;

        // Ensure that the newly cloned group has the 'section-group' class
        newGroup.classList.add('section-group');  // Add the class to the cloned group

        container.appendChild(newGroup);
    }

    // Remove a specific section group (dropdowns for department and section)
    function removeSectionGroup(button) {
        const group = button.closest('.section-group');
        if (group) {
            group.remove();  // Only remove if group is found
        }
    }

    // Remove a section row from the table
    function removeSectionRow(button) {
        const row = button.closest('tr');
        if (row) {
            row.remove();  // Only remove if row is found
        }
    }


    // Handle the form submission via AJAX to update teacher details
    // Handle the form submission via AJAX to update teacher details
    document.getElementById('editTeacherForm').addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent the default form submission

        const formData = new FormData(this);  // Create a FormData object from the form

        const teacherId = document.getElementById('teacher_id_edit_modal').value; // Get teacher ID from the modal

        fetch(`/admin_teacher/${teacherId}/edit/`, {  // Use the correct URL for editing the teacher
            method: 'POST',
            body: formData  // Send the form data with the request
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Teacher updated successfully!');
                    closeEditModal();
                    location.reload();  // Reload the page to show the updated teacher list
                } else {
                    alert('Error updating teacher.');
                }
            })
            .catch(error => {
                console.error('Error updating teacher:', error);
                alert('Something went wrong!');
            });
    });
</script>
