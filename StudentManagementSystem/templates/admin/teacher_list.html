<div class="card radius-10" id="teacher_table">
    <div class="card-body p-5">
        <h6 class="mb-0 text-uppercase">Teacher List</h6>

        <!-- For the edit form -->
        <div id="list_message">
            {% if messages %}
                {% for message in messages %}
                    {% if 'list_message' in message.tags %}
                        {% include 'utility/alert_message.html' %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>


        <hr>
        <table class="table mb-0 table-hover">
            <thead>
            <tr class="text-center">
                <th scope="col">Teacher ID</th>
                <th scope="col">First Name</th>
                <th scope="col">Last Name</th>
                <th scope="col">Handled Sections</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for item in teachers_with_sections %}
                <tr>
                    <td>{{ item.teacher.teacher_id }}</td>
                    <td>{{ item.teacher.first_name }}</td>
                    <td>{{ item.teacher.last_name }}</td>
                    <td style="width: 250px">
                        <!-- Display sections as a list -->
                        <div class="row row-cols-3 g-1">
                            {% for section_name in item.section_names %}
                                <div class="col">
                                    <span class="badge bg-primary px-3 py-2 text-center w-100">{{ section_name }}</span>
                                </div>
                            {% empty %}
                                <span class="text-muted">No section(s) assigned.</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="text-center">
                        <!-- Edit Button Triggering the Modal -->
                        <button type="button" class="btn btn-primary btn-sm"
                                onclick="openEditModal({{ item.teacher.id }})">
                            Edit
                        </button>
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="deleteTeacher({{ item.teacher.id }})">
                            Delete
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="text-center font-22">No teachers found.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>


    </div>
</div>

<!-- Custom Modal for Editing Teacher's Information -->
<div class="modal fade" id="exampleVerticallycenteredModal" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="--bs-modal-width: 800px">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editTeacherForm">

                <div class="modal-body p-5">

                    {% csrf_token %}

                    <input type="hidden" name="show_in_table_modal" id="show_in_table_modal" value="true">
                    <input type="hidden" name="teacher_id_edit_modal" id="teacher_id_edit_modal"
                           value="{{ teacher.id }}">


                    <div class="row mb-3">
                        <div class="col-4">
                            <label for="first_name_modal" class="form-label">Full Name: </label>
                        </div>
                        <div class="col-8">


                            <div class="row">
                                <div class="col-6">
                                    <input type="text" class="form-control" id="first_name_modal"
                                           name="first_name_modal"
                                           required>
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control" id="last_name_modal" name="last_name_modal"
                                           required>
                                </div>
                            </div>


                        </div>

                    </div>

                    <div class="row">

                        <div class="col-4">
                            <label for="password_modal" class="form-label">Password (Optional):</label>
                        </div>
                        <div class="col-8">
                            <div class="input-group mb-3">
                                <input type="password" class="form-control" id="password_modal" name="password_modal">
                                <a href="javascript:;" class="input-group-text bg-transparent"
                                   id="togglePasswordModal"><i
                                        class="bx bx-hide"></i></a>
                                <button class="btn btn-outline-primary btn-sm" type="button" id="button-addon3">Generate
                                    Password
                                </button>
                            </div>

                        </div>
                    </div>


                    <h5>Handled Sections</h5>
                    <table class="table text-center" id="sections-table">
                        <thead>
                        <tr>
                            <th>Sections</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Existing sections will be dynamically added here -->
                        </tbody>
                    </table>

                    <h5>Add New Section</h5>
                    <div id="section-group-container_modal">
                        <div class="section-group_modal mb-3">
                            <div class="row" id="section_group_modal_duplicate">
                                <div class="col-6">
                                    <label for="departments" class="form-label">Department</label>
                                    <select name="departments[]" class="form-control dept-select">
                                        <option value="">-- Select Department --</option>
                                        {% for dept in departments %}
                                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label for="letters" class="form-label">Section Letter</label>
                                    <select name="letters[]" class="form-control section-select">
                                        <option value="">-- Select Section Letter --</option>
                                        {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                                            <option value="{{ letter }}">{{ letter }}</option>
                                        {% endfor %}
                                    </select>
                                </div>


                            </div>


                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-success float-end btn-sm ms-2"
                                        onclick="addSectionGroupModal()">
                                    <i class="bx bx-plus mr-1"></i>Add More Sections
                                </button>
                                <button type="button" class="btn btn-outline-danger float-end btn-sm ms-2"
                                        onclick="removeLastSectionModal()">
                                    <i class="bx bx-minus mr-1"></i>Remove Last Section
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="save_button">
                        Save changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


{% include "utility/modal_dialogue.html" with modal_id="deleteTeacherModal" modal_title="Confirm Delete" modal_body="<span>Are you sure you want to delete this teacher?</span>" modal_width="400px" modal_buttons="['ok','cancel']" modal_classes="['btn btn-danger','btn btn-secondary']" %}






{% block scripts %}






    <!-- JavaScript to add more section groups -->
    <script>
        // Function to add a new section group (duplicate the section_group_modal_duplicate)
        function addSectionGroupModal() {
            // Get the container and the section to clone (target the section_group_modal_duplicate)
            var $container = $('.section-group_modal.mb-3');
            var $sectionGroup = $('#section_group_modal_duplicate');

            // Clone the section
            var $newGroup = $sectionGroup.clone();

            // Clear the values of the cloned select inputs
            $newGroup.find('select[name="departments[]"]').prop('selectedIndex', 0);
            $newGroup.find('select[name="letters[]"]').prop('selectedIndex', 0);

            // Append the cloned section under the .section-group_modal.mb-3 container
            $container.append($newGroup);
        }

        // Function to remove the last section group
        function removeLastSectionModal() {
            var $container = $('.section-group_modal.mb-3');

            // Remove the last .section-group_modal (excluding the original one)
            if ($container.find('.row').length > 1) {
                $container.find('.row').last().remove();
            } else {
                alert("You must have at least one section.");
            }
        }


    </script>





    <!-- jQuery for Modal Data Injection -->
    <script>


        function removeSectionRow(button, sectionId) {
            $.ajax({
                url: `/admin_teacher/remove_section/${sectionId}/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()  // Get the CSRF token using jQuery
                },
                success: function (data) {
                    if (data.success) {
                        $(button).closest('tr').remove();  // Remove the row from the table if deletion is successful
                    }
                },
                error: function (error) {
                    console.error('Error removing section:', error);
                }
            });
        }


        // Open the modal and pre-fill the data for a specific teacher
        function openEditModal(teacherId) {
            $.ajax({
                url: `/admin_teacher/${teacherId}/get_details/`,  // Fetch the teacher's current details
                method: 'GET',
                success: function (data) {
                    // Pre-fill the form fields with teacher's data
                    $('#teacher_id_edit_modal').val(data.teacher_id);
                    $('#first_name_modal').val(data.first_name);
                    $('#last_name_modal').val(data.last_name);
                    $('#password_modal').val('');  // Optional: clear previous password field
                    $('#show_in_table_modal').val(data.show_in_table_modal);

                    // Dynamically set the form action to the correct edit URL
                    $('#editTeacherForm').attr('action', `/admin_teacher/${teacherId}/edit/`);

                    // Show the modal
                    $('#exampleVerticallycenteredModal').modal('show'); // Use Bootstrap modal to show the modal

                    // Handle existing sections dynamically
                    const sectionTableBody = $('#sections-table tbody');
                    sectionTableBody.empty();  // Clear existing rows

                    // Dynamically add each section with a Remove button
                    data.handled_sections.forEach(function (section) {
                        const row = `
                    <tr>
                        <td>${section.section_name}</td>  <!-- Display Section Name -->
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeSectionRow(this, ${section.id})">Delete Section</button>
                        </td>
                    </tr>
                `;
                        sectionTableBody.append(row);  // Append the new row to the table body
                    });
                },
                error: function (error) {
                    console.error('Error fetching teacher data:', error);
                }
            });
        }


        let teacherToDelete = null;

        // Triggered when clicking delete button in table
        function deleteTeacher(teacherId) {
            teacherToDelete = teacherId; // store id globally
            const deleteModal = new bootstrap.Modal(document.getElementById("deleteTeacherModal"));
            deleteModal.show();
        }

        // Hook up modal buttons once page is loaded
        document.addEventListener("DOMContentLoaded", function () {
            const yesBtn = document.getElementById("deleteTeacherModal_yes");
            if (yesBtn) {
                yesBtn.addEventListener("click", function () {
                    if (!teacherToDelete) return;

                    fetch(`/admin_teacher/delete/${teacherToDelete}/`, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // remove row or refresh
                                document.querySelector(`#teacher-row-${teacherToDelete}`)?.remove();
                                location.reload();
                            } else {
                                alert("Failed to delete teacher");
                            }
                        })
                        .catch(err => {
                            console.error("Error:", err);
                            alert("An error occurred. Please try again.");
                        })
                        .finally(() => {
                            teacherToDelete = null;
                        });
                });
            }

            const cancelBtn = document.getElementById("deleteTeacherModal_cancel");
            if (cancelBtn) {
                cancelBtn.addEventListener("click", function () {
                    teacherToDelete = null;
                });
            }
        });


    </script>





{% endblock %}









