<h3>Teacher List</h3>
<table>
    <thead>
    <tr>
        <th>Teacher ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for teacher in teachers %}
        <tr>
            <td>{{ teacher.teacher_id }}</td>
            <td>{{ teacher.first_name }}</td>
            <td>{{ teacher.last_name }}</td>
            <td>
                <!-- Edit Button for Modal -->
                <button onclick="openEditModal({{ teacher.id }})">Edit</button>
                <button onclick="deleteTeacher({{ teacher.id }})">Delete</button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Modal for Editing Teacher's Information and Handling Sections -->
<div id="editModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">
    <h4>Edit Teacher</h4>
    <form id="editTeacherForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="teacher_id_edit_modal" id="teacher_id_edit_modal">

        <label for="first_name_modal">First Name:</label><br>
        <input type="text" id="first_name_modal" name="first_name_modal" required><br><br>

        <label for="last_name_modal">Last Name:</label><br>
        <input type="text" id="last_name_modal" name="last_name_modal" required><br><br>

        <label for="password_modal">Password (Optional):</label><br>
        <input type="password" id="password_modal" name="password_modal"><br><br>

        <h5>Handled Sections</h5>
        <table id="sections-table">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Year Level</th>
                    <th>Section Letter</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Existing sections will be dynamically added here -->
            </tbody>
        </table>

        <h5>Add New Section</h5>
        <div id="section-group-container_modal">
            <div class="section-group_modal">
                <label>Department:</label>
                <select name="departments[]" class="dept-select">
                    <option value="">-- Select Department --</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>

                <label>Section Letter:</label>
                <select name="letters[]" class="section-select">
                    <option value="">-- Select Section Letter --</option>
                    {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                        <option value="{{ letter }}">{{ letter }}</option>
                    {% endfor %}
                </select>

                <button type="button" onclick="removeSectionGroup(this)">Remove</button>
            </div>
        </div>

        <button type="button" onclick="addSectionGroupModal()">âž• Add More Sections</button>
        <br><br>
        <button type="submit">Save Changes</button>
    </form>
    <button onclick="closeEditModal()">Close</button>
</div>

<!-- Background overlay to dim the rest of the screen when modal is open -->
<div id="modalOverlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

<script>
// Open the modal and pre-fill the data for a specific teacher
function openEditModal(teacherId) {
    fetch(`/admin_teacher/${teacherId}/get_details/`)  // Fetch the teacher's current details
        .then(response => response.json())
        .then(data => {
            // Pre-fill the form with the teacher's data
            document.getElementById('teacher_id_edit_modal').value = data.teacher_id;
            document.getElementById('first_name_modal').value = data.first_name;
            document.getElementById('last_name_modal').value = data.last_name;
            document.getElementById('password_modal').value = '';  // Optional: clear previous password field

            // Show the modal
            document.getElementById('editModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';

            // Display existing handled sections in the table
            const sectionTableBody = document.querySelector('#sections-table tbody');
            sectionTableBody.innerHTML = '';  // Clear existing rows
            data.handled_sections.forEach((section) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${section.department}</td>
                    <td>${section.year_level}</td>
                    <td>${section.letter}</td>
                    <td>
                        <button type="button" onclick="removeSectionRow(this, ${section.id})">Remove</button>
                    </td>
                `;
                sectionTableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching teacher data:', error));
}

// Add a new section (dropdowns for department and section)
function addSectionGroupModal() {
    const container = document.getElementById('section-group-container_modal');
    const firstGroup = container.querySelector('.section-group_modal');
    const newGroup = firstGroup.cloneNode(true);

    // Clear values of cloned selects
    const deptSelect = newGroup.querySelector('.dept-select');
    const sectionSelect = newGroup.querySelector('.section-select');

    deptSelect.selectedIndex = 0;
    sectionSelect.selectedIndex = 0;

    newGroup.classList.add('section-group');  // Add the class to the cloned group
    container.appendChild(newGroup);
}

// Remove a section group (dropdowns for department and section)
function removeSectionGroup(button) {
    const group = button.closest('.section-group');
    if (group) {
        group.remove();  // Remove the section group
    }
}

// Remove a section row from the table (handled sections)
function removeSectionRow(button, sectionId) {
    fetch(`/admin_teacher/remove_section/${sectionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.closest('tr').remove();  // Remove the row from the table if deletion is successful
        }
    })
    .catch(error => {
        console.error('Error removing section:', error);
    });
}

// Handle the form submission via AJAX to update teacher details
document.getElementById('editTeacherForm').addEventListener('submit', function (event) {
    event.preventDefault();  // Prevent the default form submission

    const formData = new FormData(this);  // Create a FormData object from the form
    const teacherId = document.getElementById('teacher_id_edit_modal').value; // Get teacher ID from the modal

    fetch(`/admin_teacher/${teacherId}/edit/`, {  // Use the correct URL for editing the teacher
        method: 'POST',
        body: formData  // Send the form data with the request
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the modal with the new data without reloading the page
            updateModalContent(teacherId); // Call a function to update the modal with the new data
        } else {
            console.error('Error updating teacher.');
        }
    })
    .catch(error => {
        console.error('Error updating teacher:', error);
    });
});

// Function to update the modal with the latest teacher data after submission
function updateModalContent(teacherId) {
    fetch(`/admin_teacher/${teacherId}/get_details/`)  // Fetch updated teacher data
        .then(response => response.json())
        .then(data => {
            document.getElementById('first_name_modal').value = data.first_name;
            document.getElementById('last_name_modal').value = data.last_name;
            document.getElementById('password_modal').value = '';  // Optional: clear previous password field

            // Update the handled sections table
            const sectionTableBody = document.querySelector('#sections-table tbody');
            sectionTableBody.innerHTML = '';  // Clear the existing rows

            data.handled_sections.forEach((section) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${section.department}</td>
                    <td>${section.year_level}</td>
                    <td>${section.letter}</td>
                    <td>
                        <button type="button" onclick="removeSectionRow(this, ${section.id})">Remove</button>
                    </td>
                `;
                sectionTableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching updated teacher data:', error));
}

// Close the modal
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
}


function deleteTeacher(teacherId) {
    if (confirm('Are you sure you want to delete this teacher?')) {
        // Send a DELETE request to the backend
        fetch(`/admin_teacher/delete/${teacherId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the page to reflect the changes
                location.reload();  // Reload the page to show the updated teacher list
            } else {
                console.error('Error deleting teacher:', data);
                alert('Error deleting teacher.');
            }
        })
        .catch(error => {
            console.error('Error deleting teacher:', error);
            alert('Something went wrong!');
        });
    }
}




</script>
