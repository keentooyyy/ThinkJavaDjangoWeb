{#<h3>Teacher List</h3>#}
{#<table>#}
{#    <thead>#}
{#    <tr>#}
{#        <th>Teacher ID</th>#}
{#        <th>First Name</th>#}
{#        <th>Last Name</th>#}
{#        <th>Actions</th>#}
{#    </tr>#}
{#    </thead>#}
{#    <tbody>#}
{#    {% for teacher in teachers %}#}
{#        <tr>#}
{#            <td>{{ teacher.teacher_id }}</td>#}
{#            <td>{{ teacher.first_name }}</td>#}
{#            <td>{{ teacher.last_name }}</td>#}
{#            <td>#}
{#                <!-- Edit Button for Modal -->#}
{#                <button onclick="openEditModal({{ teacher.id }})">Edit</button>#}
{#                <button onclick="deleteTeacher({{ teacher.id }})">Delete</button>#}
{#            </td>#}
{#        </tr>#}
{#    {% endfor %}#}
{#    </tbody>#}
{#</table>#}
{##}
{#<!-- Modal for Editing Teacher's Information and Handling Sections -->#}
{#<div id="editModal" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 1000;">#}
{#    <h4>Edit Teacher</h4>#}
{#    <form id="editTeacherForm" method="POST">#}
{#        {% csrf_token %}#}
{#        <input type="hidden" name="teacher_id_edit_modal" id="teacher_id_edit_modal">#}
{##}
{#        <label for="first_name_modal">First Name:</label><br>#}
{#        <input type="text" id="first_name_modal" name="first_name_modal" required><br><br>#}
{##}
{#        <label for="last_name_modal">Last Name:</label><br>#}
{#        <input type="text" id="last_name_modal" name="last_name_modal" required><br><br>#}
{##}
{#        <label for="password_modal">Password (Optional):</label><br>#}
{#        <input type="password" id="password_modal" name="password_modal"><br><br>#}
{##}
{#        <h5>Handled Sections</h5>#}
{#        <table id="sections-table">#}
{#            <thead>#}
{#                <tr>#}
{#                    <th>Department</th>#}
{#                    <th>Year Level</th>#}
{#                    <th>Section Letter</th>#}
{#                    <th>Actions</th>#}
{#                </tr>#}
{#            </thead>#}
{#            <tbody>#}
{#                <!-- Existing sections will be dynamically added here -->#}
{#            </tbody>#}
{#        </table>#}
{##}
{#        <h5>Add New Section</h5>#}
{#        <div id="section-group-container_modal">#}
{#            <div class="section-group_modal">#}
{#                <label>Department:</label>#}
{#                <select name="departments[]" class="dept-select">#}
{#                    <option value="">-- Select Department --</option>#}
{#                    {% for dept in departments %}#}
{#                        <option value="{{ dept.id }}">{{ dept.name }}</option>#}
{#                    {% endfor %}#}
{#                </select>#}
{##}
{#                <label>Section Letter:</label>#}
{#                <select name="letters[]" class="section-select">#}
{#                    <option value="">-- Select Section Letter --</option>#}
{#                    {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}#}
{#                        <option value="{{ letter }}">{{ letter }}</option>#}
{#                    {% endfor %}#}
{#                </select>#}
{##}
{#                <button type="button" onclick="removeSectionGroup(this)">Remove</button>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <button type="button" onclick="addSectionGroupModal()">âž• Add More Sections</button>#}
{#        <br><br>#}
{#        <button type="submit">Save Changes</button>#}
{#    </form>#}
{#    <button onclick="closeEditModal()">Close</button>#}
{#</div>#}
{##}
{#<!-- Background overlay to dim the rest of the screen when modal is open -->#}
{#<div id="modalOverlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>#}
{##}
{#<script>#}
{#// Open the modal and pre-fill the data for a specific teacher#}
{#function openEditModal(teacherId) {#}
{#    fetch(`/admin_teacher/${teacherId}/get_details/`)  // Fetch the teacher's current details#}
{#        .then(response => response.json())#}
{#        .then(data => {#}
{#            // Pre-fill the form with the teacher's data#}
{#            document.getElementById('teacher_id_edit_modal').value = data.teacher_id;#}
{#            document.getElementById('first_name_modal').value = data.first_name;#}
{#            document.getElementById('last_name_modal').value = data.last_name;#}
{#            document.getElementById('password_modal').value = '';  // Optional: clear previous password field#}
{##}
{#            // Show the modal#}
{#            document.getElementById('editModal').style.display = 'block';#}
{#            document.getElementById('modalOverlay').style.display = 'block';#}
{##}
{#            // Display existing handled sections in the table#}
{#            const sectionTableBody = document.querySelector('#sections-table tbody');#}
{#            sectionTableBody.innerHTML = '';  // Clear existing rows#}
{#            data.handled_sections.forEach((section) => {#}
{#                const row = document.createElement('tr');#}
{#                row.innerHTML = `#}
{#                    <td>${section.department}</td>#}
{#                    <td>${section.year_level}</td>#}
{#                    <td>${section.letter}</td>#}
{#                    <td>#}
{#                        <button type="button" onclick="removeSectionRow(this, ${section.id})">Remove</button>#}
{#                    </td>#}
{#                `;#}
{#                sectionTableBody.appendChild(row);#}
{#            });#}
{#        })#}
{#        .catch(error => console.error('Error fetching teacher data:', error));#}
{#}#}
{##}
{#// Add a new section (dropdowns for department and section)#}
{#function addSectionGroupModal() {#}
{#    const container = document.getElementById('section-group-container_modal');#}
{#    const firstGroup = container.querySelector('.section-group_modal');#}
{#    const newGroup = firstGroup.cloneNode(true);#}
{##}
{#    // Clear values of cloned selects#}
{#    const deptSelect = newGroup.querySelector('.dept-select');#}
{#    const sectionSelect = newGroup.querySelector('.section-select');#}
{##}
{#    deptSelect.selectedIndex = 0;#}
{#    sectionSelect.selectedIndex = 0;#}
{##}
{#    newGroup.classList.add('section-group');  // Add the class to the cloned group#}
{#    container.appendChild(newGroup);#}
{#}#}
{##}
{#// Remove a section group (dropdowns for department and section)#}
{#function removeSectionGroup(button) {#}
{#    const group = button.closest('.section-group');#}
{#    if (group) {#}
{#        group.remove();  // Remove the section group#}
{#    }#}
{#}#}
{##}
{#// Remove a section row from the table (handled sections)#}
{#function removeSectionRow(button, sectionId) {#}
{#    fetch(`/admin_teacher/remove_section/${sectionId}/`, {#}
{#        method: 'POST',#}
{#        headers: {#}
{#            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value#}
{#        }#}
{#    })#}
{#    .then(response => response.json())#}
{#    .then(data => {#}
{#        if (data.success) {#}
{#            button.closest('tr').remove();  // Remove the row from the table if deletion is successful#}
{#        }#}
{#    })#}
{#    .catch(error => {#}
{#        console.error('Error removing section:', error);#}
{#    });#}
{#}#}
{##}
{#// Handle the form submission via AJAX to update teacher details#}
{#document.getElementById('editTeacherForm').addEventListener('submit', function (event) {#}
{#    event.preventDefault();  // Prevent the default form submission#}
{##}
{#    const formData = new FormData(this);  // Create a FormData object from the form#}
{#    const teacherId = document.getElementById('teacher_id_edit_modal').value; // Get teacher ID from the modal#}
{##}
{#    fetch(`/admin_teacher/${teacherId}/edit/`, {  // Use the correct URL for editing the teacher#}
{#        method: 'POST',#}
{#        body: formData  // Send the form data with the request#}
{#    })#}
{#    .then(response => response.json())#}
{#    .then(data => {#}
{#        if (data.success) {#}
{#            // Update the modal with the new data without reloading the page#}
{#            updateModalContent(teacherId); // Call a function to update the modal with the new data#}
{#            closeEditModal();#}
{#            location.reload();#}
{#        } else {#}
{#            console.error('Error updating teacher.');#}
{#        }#}
{#    })#}
{#    .catch(error => {#}
{#        console.error('Error updating teacher:', error);#}
{#    });#}
{#});#}
{##}
{#// Function to update the modal with the latest teacher data after submission#}
{#function updateModalContent(teacherId) {#}
{#    fetch(`/admin_teacher/${teacherId}/get_details/`)  // Fetch updated teacher data#}
{#        .then(response => response.json())#}
{#        .then(data => {#}
{#            document.getElementById('first_name_modal').value = data.first_name;#}
{#            document.getElementById('last_name_modal').value = data.last_name;#}
{#            document.getElementById('password_modal').value = '';  // Optional: clear previous password field#}
{##}
{#            // Update the handled sections table#}
{#            const sectionTableBody = document.querySelector('#sections-table tbody');#}
{#            sectionTableBody.innerHTML = '';  // Clear the existing rows#}
{##}
{#            data.handled_sections.forEach((section) => {#}
{#                const row = document.createElement('tr');#}
{#                row.innerHTML = `#}
{#                    <td>${section.department}</td>#}
{#                    <td>${section.year_level}</td>#}
{#                    <td>${section.letter}</td>#}
{#                    <td>#}
{#                        <button type="button" onclick="removeSectionRow(this, ${section.id})">Remove</button>#}
{#                    </td>#}
{#                `;#}
{#                sectionTableBody.appendChild(row);#}
{#            });#}
{#        })#}
{#        .catch(error => console.error('Error fetching updated teacher data:', error));#}
{#}#}
{##}
{#// Close the modal#}
{#function closeEditModal() {#}
{#    document.getElementById('editModal').style.display = 'none';#}
{#    document.getElementById('modalOverlay').style.display = 'none';#}
{#}#}
{##}
{##}
{#function deleteTeacher(teacherId) {#}
{#    if (confirm('Are you sure you want to delete this teacher?')) {#}
{#        // Send a DELETE request to the backend#}
{#        fetch(`/admin_teacher/delete/${teacherId}/`, {#}
{#            method: 'DELETE',#}
{#            headers: {#}
{#                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value#}
{#            }#}
{#        })#}
{#        .then(response => response.json())#}
{#        .then(data => {#}
{#            if (data.success) {#}
{#                // Refresh the page to reflect the changes#}
{#                location.reload();  // Reload the page to show the updated teacher list#}
{#            } else {#}
{#                console.error('Error deleting teacher:', data);#}
{#                alert('Error deleting teacher.');#}
{#            }#}
{#        })#}
{#        .catch(error => {#}
{#            console.error('Error deleting teacher:', error);#}
{#            alert('Something went wrong!');#}
{#        });#}
{#    }#}
{#}#}
{##}
{##}
{##}
{##}
{#</script>#}

<div class="card" id="teacher_table">
    <div class="card-body p-5">
        <h6 class="mb-0 text-uppercase">Teacher List</h6>


        <!-- Display messages for the form -->
        {% if show_in_table %}
            <div class="d-block">
                {% include 'utility/alert_message.html' %}
            </div>
        {% else %}
            <div class="d-none">
                {% include 'utility/alert_message.html' %}
            </div>
        {% endif %}

        <hr>
        <table class="table mb-0 table-hover">
            <thead>
            <tr class="text-center">
                <th scope="col">Teacher ID</th>
                <th scope="col">First Name</th>
                <th scope="col">Last Name</th>
                <th scope="col">Handled Sections</th>
                <th scope="col">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for item in teachers_with_sections %}
                <tr>
                    <td>{{ item.teacher.teacher_id }}</td>
                    <td>{{ item.teacher.first_name }}</td>
                    <td>{{ item.teacher.last_name }}</td>
                    <td>
                        <!-- Display sections as a list -->
                        <div class="bootstrap-tagsinput inline">
                            {% for section_name in item.section_names %}
                                <span class="badge bg-primary px-3 py-2">{{ section_name }}</span>
                                {% if forloop.counter|divisibleby:3 %}
                                    <br>
                                    <div class="mt-1"></div><!-- Add a line break every 3 items -->
                                {% endif %}
                            {% empty %}
                                <span class="badge bg-secondary">No sections</span>
                                <!-- If no sections, display this -->
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <!-- Edit Button Triggering the Modal -->
                        <button type="button" class="btn btn-primary btn-sm"
                                onclick="openEditModal({{ item.teacher.id }})">
                            Edit
                        </button>
                        <button type="button" class="btn btn-danger btn-sm"
                                onclick="deleteTeacher({{ item.teacher.id }})">
                            Delete
                        </button>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5">No teachers found.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>


    </div>
</div>

<!-- Custom Modal for Editing Teacher's Information -->
<div class="modal fade" id="exampleVerticallycenteredModal" tabindex="-1" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="--bs-modal-width: 800px">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Teacher</h5>


                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editTeacherForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="teacher_id_edit_modal" id="teacher_id_edit_modal"
                           value="{{ teacher.id }}">

                    <div class="mb-3">
                        <label for="first_name_modal" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="first_name_modal" name="first_name_modal" required>
                    </div>
                    <div class="mb-3">
                        <label for="last_name_modal" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="last_name_modal" name="last_name_modal" required>
                    </div>
                    <div class="mb-3">
                        <label for="password_modal" class="form-label">Password (Optional)</label>
                        <input type="password" class="form-control" id="password_modal" name="password_modal">
                    </div>

                    <h5>Handled Sections</h5>
                    <table class="table" id="sections-table">
                        <thead>
                        <tr>
                            <th>Department</th>
                            <th>Year Level</th>
                            <th>Section Letter</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Existing sections will be dynamically added here -->
                        </tbody>
                    </table>

                    <h5>Add New Section</h5>
                    <div id="section-group-container_modal">
                        <div class="section-group_modal">
                            <label for="departments" class="form-label">Department</label>
                            <select name="departments[]" class="form-control dept-select">
                                <option value="">-- Select Department --</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>

                            <label for="letters" class="form-label">Section Letter</label>
                            <select name="letters[]" class="form-control section-select">
                                <option value="">-- Select Section Letter --</option>
                                {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                                    <option value="{{ letter }}">{{ letter }}</option>
                                {% endfor %}
                            </select>

                            <button type="button" class="btn btn-danger btn-sm" onclick="removeSectionGroup(this)">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Background overlay to dim the rest of the screen when modal is open -->
<div id="modalOverlay"
     style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>






{% block scripts %}


    <!-- jQuery for Modal Data Injection -->
    <script>

        function removeSectionRow(button, sectionId) {
            $.ajax({
                url: `/admin_teacher/remove_section/${sectionId}/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()  // Get the CSRF token using jQuery
                },
                success: function (data) {
                    if (data.success) {
                        $(button).closest('tr').remove();  // Remove the row from the table if deletion is successful
                    }
                },
                error: function (error) {
                    console.error('Error removing section:', error);
                }
            });
        }


        // Open the modal and pre-fill the data for a specific teacher
        // Open the modal and pre-fill the data for a specific teacher
        function openEditModal(teacherId) {
            $.ajax({
                url: `/admin_teacher/${teacherId}/get_details/`,  // Fetch the teacher's current details
                method: 'GET',
                success: function (data) {
                    // Pre-fill the form fields with teacher's data
                    $('#teacher_id_edit_modal').val(data.teacher_id);
                    $('#first_name_modal').val(data.first_name);
                    $('#last_name_modal').val(data.last_name);
                    $('#password_modal').val('');  // Optional: clear previous password field

                    // Dynamically set the form action to the correct edit URL
                    $('#editTeacherForm').attr('action', `/admin_teacher/${teacherId}/edit/`);

                    // Show the modal
                    $('#exampleVerticallycenteredModal').modal('show'); // Use Bootstrap modal to show the modal

                    // Handle existing sections dynamically
                    const sectionTableBody = $('#sections-table tbody');
                    sectionTableBody.empty();  // Clear existing rows
                    data.handled_sections.forEach(function (section) {
                        const row = `
                    <tr>
                        <td>${section.department}</td>
                        <td>${section.year_level}</td>
                        <td>${section.letter}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeSectionRow(this, ${section.id})">Remove</button>
                        </td>
                    </tr>
                `;
                        sectionTableBody.append(row);
                    });
                },
                error: function (error) {
                    console.error('Error fetching teacher data:', error);
                }
            });
        }


        $('#editTeacherForm').submit(function (event) {
            event.preventDefault();  // Prevent the default form submission

            var formData = new FormData(this);  // Create a FormData object from the form
            var teacherId = $('#teacher_id_edit_modal').val();  // Get teacher ID from the modal

            $.ajax({
                url: '/admin_teacher/' + teacherId + '/edit/',  // Use the correct URL for editing the teacher
                method: 'POST',
                data: formData,  // Send the form data with the request
                contentType: false,  // Needed to send FormData
                processData: false,  // Needed to send FormData
                success: function (data) {
                    if (data.success) {
                        location.reload();  // Optionally reload the page to reflect the changes
                    } else {
                        console.error('Error updating teacher.');
                    }
                },
                error: function (error) {
                    console.error('Error updating teacher:', error);
                }
            });
        });

    </script>


{% endblock %}









