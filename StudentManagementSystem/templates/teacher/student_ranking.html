{#<h2>Select Department and Section</h2>#}
{##}
{#<form method="GET" id="filter-form">#}
{#    <!-- Department Dropdown -->#}
{#    <label for="department">Department</label>#}
{#    <select name="department" id="department" onchange="loadSections()">#}
{#        <option value="">Select Department</option>#}
{#        {% for department in departments %}#}
{#            <option value="{{ department.name }}"#}
{#                    {% if department.name == department_filter %}selected{% endif %}>#}
{#                {{ department.name }}#}
{#            </option>#}
{#        {% endfor %}#}
{#    </select>#}
{##}
{#    <!-- Section Dropdown -->#}
{#    <label for="section">Section</label>#}
{#    <select name="section_filter" id="section-filter">#}
{#        <option value="">Select Section</option>#}
{#        {% for section in sections_for_department %}#}
{#            <option value="{{ section.section_value }}"#}
{#                    {% if section.section_value == section_filter %}selected{% endif %}>#}
{#                {{ section.section_display }}#}
{#            </option>#}
{#        {% endfor %}#}
{#    </select>#}
{##}
{#    <!-- Hidden Submit Button -->#}
{#    <button type="submit" style="display:none;">Filter</button>#}
{#</form>#}
{##}
{#<h3>Student Performance Rankings</h3>#}
{#<div id="rankings-table">#}
{#    {% include 'teacher/rankings_table.html' %}#}
{#</div>#}
{##}
{#<script>#}
{#    function loadSections() {#}
{#        const department = document.getElementById('department').value;#}
{##}
{#        if (department) {#}
{#            // Send AJAX request to get sections for the selected department#}
{#            fetch(`/get-sections-by-department/?department=${department}`)#}
{#                .then(response => response.json())#}
{#                .then(data => {#}
{#                    const sectionFilter = document.getElementById('section-filter');#}
{#                    sectionFilter.innerHTML = ''; // Clear current options#}
{#                    const defaultOption = document.createElement('option');#}
{#                    defaultOption.value = '';#}
{#                    defaultOption.textContent = 'All Sections';#}
{#                    sectionFilter.appendChild(defaultOption);#}
{##}
{#                    // Populate the section dropdown with the fetched sections#}
{#                    data.sections.forEach(section => {#}
{#                        const option = document.createElement('option');#}
{#                        option.value = section.value;#}
{#                        option.textContent = section.label;#}
{#                        sectionFilter.appendChild(option);#}
{#                    });#}
{##}
{#                    // Trigger form submission if section is already selected (optional)#}
{#                    if (sectionFilter.value) {#}
{#                        submitForm();#}
{#                    }#}
{#                })#}
{#                .catch(error => console.error('Error loading sections:', error));#}
{#        } else {#}
{#            // If no department selected, reset section options#}
{#            const sectionFilter = document.getElementById('section-filter');#}
{#            sectionFilter.innerHTML = '';#}
{#            const defaultOption = document.createElement('option');#}
{#            defaultOption.value = '';#}
{#            defaultOption.textContent = 'All Sections';#}
{#            sectionFilter.appendChild(defaultOption);#}
{#        }#}
{#    }#}
{##}
{#    function submitForm() {#}
{#        const department = document.getElementById('department').value;#}
{#        const section = document.getElementById('section-filter').value;#}
{##}
{#        // Build the URL with query parameters#}
{#        const url = new URL(window.location.href);#}
{#        const params = new URLSearchParams(url.search);#}
{##}
{#        if (department) {#}
{#            params.set('department', department);#}
{#        } else {#}
{#            params.delete('department');#}
{#        }#}
{##}
{#        if (section) {#}
{#            params.set('section', section);#}
{#        } else {#}
{#            params.delete('section');#}
{#        }#}
{##}
{#        history.pushState(null, '', url.pathname + '?' + params.toString());#}
{##}
{#        fetch(url.pathname + '?' + params.toString(), {#}
{#            method: 'GET',#}
{#            headers: { 'X-Requested-With': 'XMLHttpRequest' }#}
{#        })#}
{#        .then(response => response.json())#}
{#        .then(data => {#}
{#            document.getElementById('rankings-table').innerHTML = data.updated_table_html;#}
{#        })#}
{#        .catch(error => {#}
{#            console.error('Error fetching filtered data:', error);#}
{#        });#}
{#    }#}
{#</script>#}
{##}
