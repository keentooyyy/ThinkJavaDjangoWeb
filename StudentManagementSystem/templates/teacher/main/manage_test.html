{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Test - {{ test.name }}{% endblock %}

{% block sidebar %}
    {% include 'sidebar.html' %}
{% endblock %}

{% block header %}
    {% include 'header.html' %}
{% endblock %}

{% block content %}
    <div class="page-wrapper p-5">

        <!-- Test Info -->
        <div class="row">
            <div class="col">
                <div class="card mx-auto" style="width: 65%;">
                    <div class="card-body p-5">
                        <form id="test-form" method="post" action="{% url 'update_test' test.id %}">
                            {% csrf_token %}

                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- View Mode -->
                                <div id="test-view">
                                    <h6>Manage Test: {{ test.name }}</h6>
                                    <p class="mb-0 text-muted small">
                                        {{ test.get_test_type_display|upper }} â€¢
                                        Created: {{ test.created_at|date:"M d, Y" }}
                                    </p>
                                </div>

                                <!-- Edit Mode Fields -->
                                <div id="test-edit-fields" class="d-none">
                                    <div class="mb-2">
                                        <input type="text" name="name" class="form-control"
                                               value="{{ test.name }}" required>
                                    </div>
                                    <div class="mb-2">
                                        <select name="test_type" class="form-select">
                                            {% for val,label in test.TEST_TYPE_CHOICES %}
                                                <option value="{{ val }}"
                                                        {% if test.test_type == val %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <!-- Back/Delete -->
                                <div class="d-flex flex-column">
                                    <div class="d-flex justify-content-end gap-2">
                                        <a href="{% url 'pre_post_test_view' %}"
                                           class="btn btn-outline-secondary btn-sm">
                                            <i class="bx bx-arrow-back"></i>Back
                                        </a>
                                        <form method="post" action="{% url 'delete_test' test.id %}"
                                              onsubmit="return confirm('Delete this test permanently?')">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                <i class="bx bxs-trash"></i>Delete Test
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <hr>

                        <!-- Test settings -->
                        <h6 class="mb-3">TEST SETTINGS</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox"
                                           id="shuffle_questions" name="shuffle_questions"
                                           {% if test.shuffle_questions %}checked{% endif %}>
                                    <label class="form-check-label" for="shuffle_questions">Shuffle Questions</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox"
                                           id="shuffle_choices" name="shuffle_choices"
                                           {% if test.shuffle_choices %}checked{% endif %}>
                                    <label class="form-check-label" for="shuffle_choices">Shuffle Choices</label>
                                </div>
                            </div>

                            <!-- ðŸ”¹ Action buttons -->
                            <div class="d-flex gap-2" id="test-actions">
                                <button id="edit-test-btn" class="btn btn-outline-primary btn-sm" type="button">
                                    <i class="bx bx-edit"></i>Edit
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>


        <!-- Questions -->
        <div class="row mt-4">
            <div class="col">
                {% for q in questions %}
                    <div class="card mx-auto question-card" style="width: 65%"
                         data-test-id="{{ test.id }}" data-question-id="{{ q.id }}">
                        <div class="card-body p-5">

                            <!-- Question + Points -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="w-75">
                                    <!-- view mode -->
                                    <h6 class="mb-0 view-mode">{{ forloop.counter }}. {{ q.text }}</h6>
                                    <!-- edit mode -->
                                    <input type="text" class="form-control question-text d-none"
                                           value="{{ q.text }}" disabled>
                                </div>
                                <div class="text-end">
                                    <!-- view mode -->
                                    <p class="m-0 text-muted view-mode">{{ q.points|floatformat:"0" }} point(s)</p>
                                    <!-- edit mode -->
                                    <input type="number" class="form-control form-control-sm question-points d-none"
                                           value="{{ q.points }}" step="1" disabled>
                                </div>
                            </div>

                            <!-- Choices -->
                            <div class="mt-3 choices-wrapper-existing sortable-choices" data-qid="{{ q.id }}">
                                {% for c in q.choices.all %}
                                    <div class="input-group mb-2 choice-item" data-choice-id="{{ c.id }}">
                                        <div class="input-group-text handle">
                                            <i class="bx bx-grid-vertical"></i>
                                        </div>
                                        <input type="radio" class="mx-3 choice-correct"
                                               name="correct_choice_{{ q.id }}"
                                               {% if c.is_correct %}checked{% endif %} disabled>
                                        <input type="text" class="form-control choice-text" value="{{ c.text }}"
                                               disabled>
                                        <button type="button" class="btn btn-outline-danger remove-choice d-none"
                                                data-qid="{{ q.id }}" data-cid="{{ c.id }}">
                                            âœ•
                                        </button>
                                    </div>
                                {% empty %}
                                    <p class="text-muted">No choices yet.</p>
                                {% endfor %}
                            </div>

                            <hr>
                            <div class="d-flex justify-content-end gap-3 mt-4">
                                <button class="btn btn-sm btn-outline-primary toggle-edit">
                                    <i class="bx bx-edit"></i>
                                </button>
                                <div class="action-buttons d-none d-flex gap-3">
                                    <button type="button" class="btn btn-sm btn-success save-question">
                                        <i class="bx bx-save"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-edit">
                                        <i class="bx bx-x"></i>
                                    </button>
                                </div>
                                <button class="btn btn-sm btn-outline-danger delete-question"
                                        data-qid="{{ q.id }}">
                                    <i class="bx bx-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- New Question Form -->
        <div class="row">
            <div class="col">
                <div class="card mx-auto" style="width: 65%;">
                    <div class="card-body p-5">
                        <form method="post" id="question-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_question">

                            <!-- Question text -->
                            <div class="mb-3">
                                <input type="text" name="question_text" class="form-control"
                                       placeholder="Untitled Question" required>
                            </div>

                            <!-- Choices -->
                            <div id="choices-wrapper" class="mt-4"></div>
                            <button type="button" id="add-choice" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="bx bx-plus"></i> Add Choice
                            </button>

                            <hr>

                            <!-- Points -->
                            <div class="row">
                                <div class="col-3">
                                    <label class="form-label">Points</label>
                                    <input type="number" name="points" class="form-control" value="1" step="1">
                                </div>
                                <input type="hidden" class="form-check-input" name="required" id="required_q" checked>
                            </div>

                            <!-- Submit -->
                            <button class="btn btn-primary mt-3">
                                <i class="bx bx-save"></i> Save Question
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Choice template -->
    <div id="choice-template" class="d-none">
        <div class="input-group mb-2 choice-item">
            <div class="input-group-text handle"><i class="bx bx-grid-vertical"></i></div>
            <input type="radio" class="mx-3 choice-correct" name="is_correct">
            <input type="text" class="form-control choice-text" name="choice_text[]" placeholder="Choice" required>
            <button type="button" class="btn btn-outline-danger remove-choice">âœ•</button>
        </div>
    </div>
{% endblock %}

{% block footer %}
    {% include 'footer.html' %}
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/manage_test.js' %}"></script>
{% endblock %}
