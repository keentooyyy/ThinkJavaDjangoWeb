{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Test - {{ test.name }}{% endblock %}
{% block sidebar %}{% include 'sidebar.html' %}{% endblock %}
{% block header %}{% include 'header.html' %}{% endblock %}

{% block content %}
<div class="page-wrapper p-5">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="fw-bold mb-1">Manage MCQ Test: {{ test.name }}</h5>
                        <p class="mb-0 text-muted small">
                            {{ test.get_test_type_display|upper }} ‚Ä¢ Created: {{ test.created_at|date:"M d, Y" }}
                        </p>
                    </div>
                    <div>
                        <a href="{% url 'pre_post_test_view' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Test Settings -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Test Settings</span>
                    <form method="post" action="{% url 'delete_test' test.id %}"
                          onsubmit="return confirm('Delete this test permanently?')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm">üóë Delete Test</button>
                    </form>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'update_test_settings' test.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2">{{ test.description }}</textarea>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" name="shuffle_questions" class="form-check-input"
                                   id="shuffle_questions" {% if test.shuffle_questions %}checked{% endif %}>
                            <label for="shuffle_questions" class="form-check-label">Shuffle Questions</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" name="shuffle_choices" class="form-check-input"
                                   id="shuffle_choices" {% if test.shuffle_choices %}checked{% endif %}>
                            <label for="shuffle_choices" class="form-check-label">Shuffle Choices</label>
                        </div>
                        <button class="btn btn-primary btn-sm mt-2">üíæ Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Questions List -->
    <div class="row">
        <div class="col-12">
            {% for q in questions %}
            <div class="card shadow-sm mb-3 question-card" data-question-id="{{ q.id }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">{{ forloop.counter }}. {{ q.text }}</h6>
                        <div>
                            <span class="badge bg-success me-2">{{ q.points }} pts</span>
                            <button class="btn btn-sm btn-outline-primary toggle-edit">‚úè Edit</button>
                            <button class="btn btn-sm btn-outline-danger delete-question" data-qid="{{ q.id }}">üóë Delete</button>
                        </div>
                    </div>

                    <!-- Question text -->
                    <div class="mb-2">
                        <textarea class="form-control question-text" disabled>{{ q.text }}</textarea>
                    </div>

                    <!-- Points -->
                    <div class="mb-2">
                        <label>Points</label>
                        <input type="number" class="form-control question-points w-25" value="{{ q.points }}" disabled>
                    </div>

                    <!-- Choices -->
                    <label>Choices (drag to reorder)</label>
                    <div class="choices-wrapper-existing sortable-choices" data-qid="{{ q.id }}">
                        {% for c in q.choices.all %}
                        <div class="input-group mb-2 choice-item" data-choice-id="{{ c.id }}">
                            <div class="input-group-text handle">
                                <i class="bx bx-grid-vertical"></i>
                            </div>
                            <input type="radio" name="correct_choice_{{ q.id }}" class="mx-3 choice-correct"
                                   {% if c.is_correct %}checked{% endif %} disabled>
                            <input type="text" class="form-control choice-text" value="{{ c.text }}" disabled>
                            <button type="button" class="btn btn-outline-danger remove-choice d-none"
                                    data-qid="{{ q.id }}" data-cid="{{ c.id }}">‚úï</button>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Add new choice -->
                    <button class="btn btn-outline-primary btn-sm mt-2 add-choice-existing d-none"
                            data-qid="{{ q.id }}">
                        ‚ûï Add Choice
                    </button>

                    <!-- Save / Cancel -->
                    <div class="mt-3 d-none action-buttons">
                        <button class="btn btn-success btn-sm save-question">üíæ Save</button>
                        <button class="btn btn-secondary btn-sm cancel-edit">‚úñ Cancel</button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info">No questions yet.</div>
            {% endfor %}
        </div>
    </div>

    <!-- üîπ Add New Question -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">‚ûï Add MCQ Question (with choices)</h6>
                    <form method="post" id="question-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_question">

                        <!-- Question Text -->
                        <div class="mb-3">
                            <label class="form-label">Question Text</label>
                            <textarea name="question_text" class="form-control" rows="2" required></textarea>
                        </div>

                        <!-- Points -->
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Points</label>
                                <input type="number" name="points" class="form-control" value="1" step="0.5">
                            </div>
                            <div class="col-md-3 d-flex align-items-center">
                                <div class="form-check mt-3">
                                    <input type="checkbox" class="form-check-input" name="required" id="required_q" checked>
                                    <label class="form-check-label" for="required_q">Required</label>
                                </div>
                            </div>
                        </div>

                        <!-- Choices -->
                        <div id="choices-wrapper" class="mt-4"></div>

                        <button type="button" id="add-choice" class="btn btn-outline-primary btn-sm mt-2">
                            <i class="bx bx-plus"></i> Add Choice
                        </button>

                        <!-- Submit -->
                        <button class="btn btn-primary mt-3">
                            <i class="bx bx-save"></i> Save Question
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üîπ Choice Template (hidden, cloned for both new & existing) -->
<div id="choice-template" class="d-none">
    <div class="input-group mb-2 choice-item">
        <div class="input-group-text handle"><i class="bx bx-grid-vertical"></i></div>
        <input type="radio" class="mx-3 choice-correct">
        <input type="text" class="form-control choice-text" placeholder="Choice" required>
        <button type="button" class="btn btn-outline-danger remove-choice">‚úï</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
$(function () {

    // Toggle Edit
    $(document).on("click", ".toggle-edit", function () {
        let card = $(this).closest(".card-body");
        card.find("textarea, input").prop("disabled", false);
        card.find(".action-buttons").removeClass("d-none");
        card.find(".remove-choice").removeClass("d-none");
        card.find(".add-choice-existing").removeClass("d-none");
        $(this).addClass("d-none");
    });

    // Cancel Edit
    $(document).on("click", ".cancel-edit", function () {
        location.reload();
    });

    // Delete Question
    $(document).on("click", ".delete-question", function () {
        if (!confirm("Delete this question?")) return;
        let qid = $(this).data("qid");
        $.post("{% url 'delete_question_ajax' test.id 0 %}".replace("0", qid), {
            csrfmiddlewaretoken: "{{ csrf_token }}"
        }).done(function (resp) {
            if (resp.status === "ok") {
                $(`.question-card[data-question-id='${qid}']`).remove();
            }
        });
    });

    // Delete Choice (existing questions only)
    $(document).on("click", ".remove-choice", function () {
        let cid = $(this).data("cid");
        if (!cid) {
            // UI-only removal (new question form)
            $(this).closest(".choice-item").remove();
            return;
        }

        if (!confirm("Delete this choice?")) return;
        let qid = $(this).data("qid");
        $.post("{% url 'delete_choice_ajax' test.id 0 0 %}".replace("0/0", qid + "/" + cid), {
            csrfmiddlewaretoken: "{{ csrf_token }}"
        }).done(function (resp) {
            if (resp.status === "ok") {
                $(`.choice-item[data-choice-id='${cid}']`).remove();
            }
        });
    });

$(function () {
    // Save Question (only this question)
    $(document).on("click", ".save-question", function () {
        let card = $(this).closest(".card-body");
        let qid = card.closest(".question-card").data("question-id");
        let text = card.find(".question-text").val();
        let points = card.find(".question-points").val();

        // build choices array
        let choices = [];
        let correctId = null;
        card.find(".choice-item").each(function (i) {
            let cid = $(this).data("choice-id") || "";
            let ctext = $(this).find(".choice-text").val();
            let correct = $(this).find(".choice-correct").is(":checked");
            choices.push((cid ? cid : "") + "::" + ctext);
            if (correct) correctId = cid;
        });

        $.post("{% url 'save_question_ajax' test.id 0 %}".replace("0", qid), {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            text: text,
            points: points,
            "choices[]": choices,
            correct_id: correctId
        }).done(function () {
            location.reload();
        });
    });
});

    // Add Choice (new question form)
    $('#add-choice').click(function () {
        let wrapper = $("#choices-wrapper");
        let newChoice = $("#choice-template .choice-item").clone();

        // set proper name for radios in new form
        let index = wrapper.find(".choice-item").length;
        newChoice.find("input.choice-correct")
            .attr("name", "is_correct")
            .val(index);
        newChoice.find("input.choice-text")
            .attr("name", "choice_text[]")
            .attr("placeholder", "Choice " + (index + 1));

        // mark delete as UI-only
        newChoice.find(".remove-choice")
            .addClass("remove-choice-new")
            .removeAttr("data-qid data-cid");

        wrapper.append(newChoice);
    });

    // Add Choice (existing question in edit mode)
    $(document).on("click", ".add-choice-existing", function () {
        let qid = $(this).data("qid");
        let wrapper = $(this).closest(".card-body").find(".choices-wrapper-existing");
        let newChoice = $("#choice-template .choice-item").clone();

        // set proper radio name for this question
        newChoice.find("input.choice-correct")
            .attr("name", "correct_choice_" + qid);

        newChoice.find("input.choice-text").attr("placeholder", "New Choice");

        wrapper.append(newChoice);
    });

    // Enable SortableJS on each question's choices (existing)
    $(".sortable-choices").each(function () {
        let qid = $(this).data("qid");
        new Sortable(this, {
            animation: 150,
            handle: ".handle",
            onEnd: function (evt) {
                let order = [];
                $(evt.to).find(".choice-item").each(function () {
                    order.push($(this).data("choice-id"));
                });
                $.post("{% url 'reorder_choices_ajax' test.id 0 %}".replace("0", qid), {
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    "order[]": order
                });
            }
        });
    });

    // ‚úÖ Enable Sortable for Add Question form
    new Sortable(document.getElementById("choices-wrapper"), {
        animation: 150,
        handle: ".handle",
        onEnd: function () {
            // reindex radios + placeholders
            $("#choices-wrapper .choice-item").each(function (i) {
                $(this).find("input[type='radio']").val(i);
                $(this).find("input[type='text']").attr("placeholder", "Choice " + (i+1));
            });
        }
    });

    // Pre-populate 3 choices for new question
    for (let i = 0; i < 3; i++) {
        $('#add-choice').click();
    }
});
</script>
{% endblock %}

{% block footer %}{% include 'footer.html' %}{% endblock %}
