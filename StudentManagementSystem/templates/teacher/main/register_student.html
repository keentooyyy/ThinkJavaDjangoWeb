{% extends 'base.html' %}
{% load static %}


{% block title %}Manage Students{% endblock %}


{% block sidebar %}{% include 'sidebar.html' %} {% endblock %}


{% block header %} {% include 'header.html' %} {% endblock %}



{% block content %}
    <div class="page-wrapper">
        <div class="row p-5">
            <div class="col-7">


                <div class="card radius-10">

                    <div class="card-body p-5">
                        <h6>REGISTER NEW STUDENT</h6>
                        <hr>

                        <div id="create_message">
                            {% if messages %}
                                {% for message in messages %}
                                    {% if 'create_message' in message.tags %}
                                        {% include 'utility/alert_message.html' %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>


                        <form method="post" action="{% url 'register_student' %}">
                            {% csrf_token %}


                            <div class="row">

                                <div class="col-4">
                                    <p class="font-16">Student ID:</p>
                                </div>
                                <div class="col-8">
                                    <div class="input-group mb-3">
                                        <input name="student_id" id="student_id" class="form-control" type="text"
                                               placeholder="Student ID"
                                               aria-label="Student ID" required>
                                        <button class="btn btn-outline-primary" type="button" id="button-addon2">
                                            Generate ID
                                        </button>
                                    </div>

                                </div>
                            </div>


                            <div class="row">
                                <div class="col-4">
                                    <p class="font-16">Full Name:</p>
                                </div>
                                <div class="col-8">
                                    <div class="row">
                                        <div class="col">
                                            <input name="first_name" id="first_name" class="form-control mb-3"
                                                   type="text"
                                                   placeholder="First Name"
                                                   aria-label="default input example" required>

                                        </div>
                                        <div class="col">
                                            <input name="last_name" id="last_name" class="form-control mb-3" type="text"
                                                   placeholder="Last Name"
                                                   aria-label="default input example" required>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="row">
                                <div class="col-4">
                                    <p class="font-16">Password:</p>
                                </div>
                                <div class="col-8">
                                    <div class="input-group mb-3">
                                        <input name="password" id="password" class="form-control" type="password"
                                               placeholder="Password"
                                               aria-label="Password" value="123">
                                        <a href="javascript:" class="input-group-text bg-transparent"
                                           id="togglePassword"><i
                                                class="bx bx-hide"></i></a>
                                    </div>

                                </div>

                                <input type="hidden" name="year_level" value="1" class="d-none">
                            </div>


                            <div class="row">

                                <div class="col-4">
                                    <label for="section_id">Assign to Section:</label>
                                </div>
                                <div class="col-8"><select name="section_id" id="section_id" class="form-select"
                                                           required>
                                    {% for hs in handled_sections %}
                                        <option value="{{ hs.section.id }}">
                                            {{ hs.department.name }}{{ hs.year_level.year }}{{ hs.section.letter }}
                                        </option>
                                    {% empty %}
                                        <option disabled>No sections available</option>
                                    {% endfor %}
                                </select></div>


                            </div>

                            <button type="submit" class="btn btn-primary float-end mt-3"><i
                                    class="bx bxs-user mr-1"></i>Register Student
                            </button>
                        </form>


                    </div>
                </div>


            </div>


            {% include 'teacher/generate_section_code.html' %}

            {% include 'teacher/student_list.html' %}
        </div>


    </div>






{% endblock %}




{% block footer %}
    {% include 'footer.html' %}
{% endblock %}








{% block register_student %}

{% endblock %}

{% block scripts %}



    <script>
        $(document).ready(function () {
            $('#togglePassword').click(function () {
                var input = $('#password');
                var type = input.attr('type') === 'password' ? 'text' : 'password';
                input.attr('type', type);

                // Toggle the icon
                $(this).find('i').toggleClass('bx-hide bx-show');
            });
        });
    </script>




    <script>
        $(document).ready(function () {
            $('#button-addon2').click(function () {
                var currentYear = new Date().getFullYear(); // Get the current year
                var randomPart1 = Math.floor(Math.random() * 9000 + 1000); // Generate a 4-digit random number between 1000 and 9999
                var randomPart2 = Math.floor(Math.random() * 900 + 100); // Generate a 3-digit random number between 100 and 999
                var teacherId = currentYear.toString().slice(-2) + '-' + randomPart1 + '-' + randomPart2; // Format as xx-xxxx-xxx

                $('#student_id').val(teacherId); // Set the generated ID into the input field
            });
        });

    </script>


    <script>

let lastStudentEditBtn = null;

function openEditStudentModal(studentId, btn) {
    $.ajax({
        url: `/teacher/students/${studentId}/edit/`,
        method: 'GET',
        success: function (data) {
            if (!data.success) {
                alert("Failed to fetch student details.");
                return;
            }

            const s = data.student;

            // Fill modal fields
            $('#student_id_edit_modal').val(s.id);
            $('#student_first_name_modal').val(s.first_name);
            $('#student_last_name_modal').val(s.last_name);

            // âœ… Rebuild department dropdown
            const deptSelect = $('#student_department_modal');
            deptSelect.empty().append('<option value="">-- Select Department --</option>');

            data.departments.forEach(dept => {
                const opt = $('<option>', {
                    value: dept.id,
                    text: dept.name
                });
                if (dept.id === s.department_id) {
                    opt.prop('selected', true);
                }
                deptSelect.append(opt);
            });

            // âœ… Populate section dropdown based on current dept
            const sectionSelect = $('#student_section_modal');
            sectionSelect.empty().append('<option value="">-- Select Section --</option>');
            const currentDept = data.departments.find(d => d.id === s.department_id);
            if (currentDept) {
                currentDept.sections.forEach(sec => {
                    const opt = $('<option>', {
                        value: sec.id,
                        text: sec.year + sec.letter
                    });
                    if (sec.id === s.section_id) {
                        opt.prop('selected', true);
                    }
                    sectionSelect.append(opt);
                });
            }

            // âœ… On dept change â†’ reload sections
            deptSelect.off('change').on('change', function () {
                const selectedDeptId = $(this).val();
                sectionSelect.empty().append('<option value="">-- Select Section --</option>');
                const selectedDept = data.departments.find(d => d.id == selectedDeptId);
                if (selectedDept) {
                    selectedDept.sections.forEach(sec => {
                        const opt = $('<option>', {
                            value: sec.id,
                            text: sec.year + sec.letter
                        });
                        sectionSelect.append(opt);
                    });
                }
            });

            // Show modal
            $('#editStudentModal').modal('show');

            // Submit handler
            $('#editStudentForm').off('submit').on('submit', function (e) {
                e.preventDefault();
                let formData = $(this).serialize();

                $.ajax({
                    url: `/teacher/students/${studentId}/edit/`,
                    method: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            $('#editStudentModal').modal('hide');
                            location.reload();
                        } else {
                            alert(response.message || "Failed to update student.");
                        }
                    },
                    error: function () {
                        alert("Something went wrong while saving.");
                    }
                });
            });
        },
        error: function () {
            alert("Error fetching student data.");
        }
    });
}




// âœ… When modal closes (X, Close button, or backdrop click), return focus to the opener
$(document).ready(function () {
    $('#editStudentModal').on('hidden.bs.modal', function () {
        if (lastStudentEditBtn) {
            $(lastStudentEditBtn).focus();
            lastStudentEditBtn = null; // reset
        }
    });
});



        let deleteStudentId = null;

function deleteStudent(studentId) {
    // store student ID and show the modal
    deleteStudentId = studentId;
    $('#deleteConfirmModal').modal('show');
}

$(document).ready(function () {
    // handle confirm delete button
    $('#deleteConfirmModal_yes').on('click', function () {
        if (!deleteStudentId) return;

        $.ajax({
            url: `/teacher/students/${deleteStudentId}/delete/`,
            method: "POST",   // easier to use POST for CSRF than DELETE
            headers: {
                "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val()
            },
            success: function (response) {
                if (response.success) {
                    $('#deleteConfirmModal').modal('hide');
                    $(`#student-row-${deleteStudentId}`).remove();
                    location.reload(); // keep reload if you want flash messages
                } else {
                    alert("Failed to delete student.");
                }
            },
            error: function () {
                alert("Error deleting student.");
            }
        });
    });
});
    </script>



    <script>

        $(document).ready(function () {

            // ðŸ”‘ Toggle show/hide password for student
            $('#toggleStudentPassword').on('click', function () {
                const passwordField = $('#student_password_modal');
                const icon = $(this).find('i');

                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('bx-hide').addClass('bx-show');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('bx-show').addClass('bx-hide');
                }
            });

            // ðŸ”‘ Generate random password for student
            $('#generateStudentPassword').on('click', function () {
                const length = 16; // you can adjust length
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
                let newPassword = "";
                for (let i = 0; i < length; i++) {
                    const randomIndex = Math.floor(Math.random() * charset.length);
                    newPassword += charset[randomIndex];
                }

                // Fill the field & switch it to visible
                $('#student_password_modal').val(newPassword)
            });

        });


    </script>

      <script>

        $('#openGenerateCodeConfirm').on('click', function () {
            $('#generateCodeConfirmModal').modal('show');
        });

        $('#generateCodeConfirmModal_yes').on('click', function () {
            $('form[action="{% url "generate_section_code" %}"]').submit();
        });

    </script>


        <script>
        function copyCode(id) {
            let codeText = $("#code-" + id).text().trim();

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(codeText).then(function () {
                    alert("Copied: " + codeText);
                }).catch(function (err) {
                    console.error("Clipboard copy failed: ", err);
                    alert("Failed to copy code!");
                });
            } else {
                let $temp = $("<input>");
                $("body").append($temp);
                $temp.val(codeText).select();
                document.execCommand("copy");
                $temp.remove();
                alert("Copied: " + codeText);
            }
        }

        let deleteCodeId = null;

        function deleteCode(id) {
            deleteCodeId = id;
            $('#deleteCodeConfirmModal').modal('show');
        }

        $(document).ready(function () {
            $('#deleteCodeConfirmModal_yes').on('click', function () {
                if (!deleteCodeId) return;

                $.ajax({
                    url: "{% url 'delete_section_code' %}",
                    type: "POST",
                    data: {
                        code_id: deleteCodeId,
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    },
                    success: function (data) {
                        if (data.success) {
                            $('#deleteCodeConfirmModal').modal('hide');
                            $("#row-" + deleteCodeId).remove();
                            location.reload();
                        }
                    },
                    error: function () {
                        alert("Failed to delete join code.");
                    }
                });
            });
        });


    </script>


<script>
$(document).ready(function () {
    $("#generateCodeBtn").on("click", function () {
        const sectionId = $("#generate_section_id").val();

        $.ajax({
            url: "{% url 'check_section_code_exists' %}",
            type: "POST",
            dataType: "json",
            data: {
                section_id: sectionId,
                csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            success: function (data) {
                if (data.exists === true) {
                    // ðŸ”¹ Section already has code â†’ wire modal confirm
                    const modal = new bootstrap.Modal(document.getElementById("generateCodeConfirmModal"));
                    modal.show();

                    $("#generateCodeConfirmModal_yes")
                        .off("click")
                        .on("click", function (e) {
                            e.preventDefault();
                            $("#generateSectionForm").submit();
                            modal.hide();
                        });
                } else {
                    // ðŸ”¹ No code exists â†’ submit directly
                    $("#generateSectionForm").submit();
                }
            },
            error: function (xhr) {
                let errMsg = "Unknown error";
                try {
                    errMsg = JSON.parse(xhr.responseText).error || errMsg;
                } catch (e) {}
                alert("Error checking section code: " + errMsg);
            }
        });
    });
});

</script>
{% endblock %}




