{% extends 'base.html' %}
{% load list_extras %}
{% load static %}

{% block title %}Manage Tests{% endblock %}
{% block sidebar %}{% include 'sidebar.html' %}{% endblock %}
{% block header %}{% include 'header.html' %}{% endblock %}

{% block content %}
    <style>
        #tests-list .test-item {
            display: none;
        }

        #tests-list.ready .test-item {
            display: block;
        }
    </style>
    <div class="page-wrapper p-5">


        <div class="row">
            <div class="col-7">
                <div class="card">
                    <div class="card-body p-5">
                        <h6>CREATE NEW TEST</h6>
                        <hr>

                        <form method="post">
                            {% csrf_token %}
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">TEST NAME</label>
                                    <input type="text" name="name" class="form-control" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">TEST TYPE</label>
                                    <select name="test_type" class="form-select">
                                        {% for value, label in test_types %}
                                            <option value="{{ value }}">{{ label|upper }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col mt-3">
                                    <label class="form-label">SHUFFLE SETTINGS</label><br>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="shuffle_questions"
                                               id="sq">
                                        <label class="form-check-label" for="sq">Questions</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="shuffle_choices" id="sc"
                                               checked>
                                        <label class="form-check-label" for="sc">Choices</label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bx bx-plus"></i> CREATE
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card">
                    <div class="card-body p-5">
                        <h6>TESTS CREATED</h6>
                        <hr>
                        <div id="tests-list" style="min-height: 168px;">

                            {% for test in tests %}
                                <div class="modal fade" id="assignModal{{ test.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">

                                            <!-- Header -->
                                            <div class="modal-header">
                                                <h5 class="modal-title">Give Test Sections</h5>
                                                <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal"></button>
                                            </div>

                                            <!-- Body -->
                                            <form method="post" action="{% url 'assign_test' test.id %}">
                                                {% csrf_token %}
                                                <div class="modal-body">
                                                    <label class="form-label">Assign Sections</label>
                                                    {% with assigned_ids=assigned_map|get_item:test.id %}
                                                        {% for hs in request.user_obj.handled_sections.all %}
                                                            <div class="form-check form-switch mb-2">
                                                                <input class="form-check-input"
                                                                       type="checkbox"
                                                                       id="sectionSwitch{{ test.id }}_{{ hs.section.id }}"
                                                                       name="section_ids"
                                                                       value="{{ hs.section.id }}"
                                                                       {% if hs.section.id in assigned_ids %}checked{% endif %}>
                                                                <label class="form-check-label"
                                                                       for="sectionSwitch{{ test.id }}_{{ hs.section.id }}">
                                                                    {{ hs.section.department.name }}{{ hs.section.year_level.year }}{{ hs.section.letter }}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    {% endwith %}
                                                    <small class="text-muted">Toggle ON to assign this test to a
                                                        section.</small>
                                                </div>


                                                <!-- Footer -->
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Cancel
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">Save Assignment
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="test-item mt-3">
                                    <h6 class="fw-bold">
                                        {{ test.name }}
                                        <span class="badge bg-info">{{ test.get_test_type_display }}</span>
                                    </h6>
                                    <div class="small text-muted">
                                        Created at {{ test.created_at|date:"M d, Y H:i" }}
                                    </div>

                                    <!-- Assigned Sections info -->
                                    <div class="mt-1">
                                        {% with assigned_ids=assigned_map|get_item:test.id %}
                                            {% if assigned_ids %}
                                                <span class="small">Assigned to:</span>
                                                {% for hs in request.user_obj.handled_sections.all %}
                                                    {% if hs.section.id in assigned_ids %}
                                                        <span class="badge bg-primary">
                            {{ hs.section.department.name }}{{ hs.section.year_level.year }}{{ hs.section.letter }}
                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="small text-muted">Not assigned to any section</span>
                                            {% endif %}
                                        {% endwith %}
                                    </div>

                                    <!-- Action buttons -->
                                    <div class="mt-2 d-flex gap-2">
                                        <a href="{% url 'manage_test_view' test.id %}"
                                           class="btn btn-outline-secondary btn-sm">
                                            <i class="bx bx-edit"></i> Manage Questions
                                        </a>

                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                data-bs-toggle="modal" data-bs-target="#assignModal{{ test.id }}">
                                            <i class="bx bx-link"></i> Section Assignment
                                        </button>
                                    </div>
                                </div>


                            {% empty %}
                                <div class="text-muted">No tests created yet.</div>
                            {% endfor %}
                        </div>

                        <!-- Pagination UI -->
                        <div id="tests-pagination"
                             class="d-flex justify-content-center mt-4 flex-column align-center"></div>
                    </div>
                </div>
            </div>


        </div>
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-body p-5">
                        <h6>ALL TEST RESULTS</h6>
                        <hr>
                        <form method="get">
                            <select name="test_id" class="form-select w-auto d-inline" onchange="this.form.submit()">
                                <option value="">All Tests</option>
                                {% for tid, group in grouped_results.items %}
                                    <option value="{{ tid }}"
                                            {% if request.GET.test_id == tid|stringformat:"s" %}selected{% endif %}>
                                        {{ group.test.name }} ({{ group.test.get_test_type_display }})
                                    </option>
                                {% endfor %}
                            </select>
                        </form>

                        {% if grouped_results %}
                            {% for tid, group in grouped_results.items %}
                                <div class="mb-4">
                                    <h6 class="fw-bold">
                                        {{ group.test.name }}
                                        <span class="badge bg-info">{{ group.test.get_test_type_display }}</span>
                                    </h6>
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Section</th>
                                            <th>Score</th>
                                            <th>Out of</th>
                                            <th>Taken At</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for st in group.rows %}
                                            <tr>
                                                <td>{{ st.student.first_name }} {{ st.student.last_name }}</td>
                                                <td>{{ st.student.full_section }}</td>
                                                <td>{{ st.score|default:"-" }}</td>
                                                <td>{{ group.max_points }}</td>
                                                <td>{{ st.taken_at|date:"M d, Y H:i" }}</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted">No results yet.</div>
                        {% endif %}


                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block footer %}{% include 'footer.html' %}{% endblock %}

{% block scripts %}
    <script>
        $(function () {
            const itemsPerPage = 2;
            const $list = $("#tests-list");
            const $items = $list.find(".test-item");
            const $pagination = $("#tests-pagination");
            const totalItems = $items.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            if (totalItems <= itemsPerPage) {
                $list.addClass("ready"); // show all if no pagination needed
                return;
            }

            let currentPage = 1;

            function showPage(page) {
                $items.hide();
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                $items.slice(start, end).show();

                renderPagination(page);
            }

            function renderPagination(page) {
                let html = `<ul class="pagination justify-content-center mb-0">`;

                // Prev button
                html += `<li class="page-item ${page === 1 ? "disabled" : ""}">
                    <a class="page-link" href="#" data-page="${page - 1}">«</a>
                 </li>`;

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    html += `<li class="page-item ${i === page ? "active" : ""}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                     </li>`;
                }

                // Next button
                html += `<li class="page-item ${page === totalPages ? "disabled" : ""}">
                    <a class="page-link" href="#" data-page="${page + 1}">»</a>
                 </li>`;

                html += `</ul><div class="text-center mt-1">Page ${page} of ${totalPages}</div>`;
                $pagination.html(html);
            }

            // Handle clicks
            $pagination.on("click", "a[data-page]", function (e) {
                e.preventDefault();
                const targetPage = parseInt($(this).data("page"));
                if (targetPage >= 1 && targetPage <= totalPages) {
                    currentPage = targetPage;
                    showPage(currentPage);
                }
            });

            // Init + reveal
            showPage(currentPage);
            $list.addClass("ready"); // reveal only after pagination is set
        });
        $(function () {
            $(".assign-form").on("submit", function (e) {
                e.preventDefault();
                const $form = $(this);
                const url = $form.attr("action");
                const data = $form.serialize();

                $.post(url, data)
                    .done(function (res) {
                        // show a toast or success message
                        alert("✅ Assignment saved!");
                        // close modal
                        $form.closest(".modal").modal("hide");

                        // Optional: update "Assigned to" badges in card without reload
                        // You could return JSON of assigned sections and update DOM here
                    })
                    .fail(function () {
                        alert("❌ Failed to save assignment.");
                    });
            });
        });
    </script>
{% endblock %}
